# 登录验证功能使用说明

## 功能概述

已为博客系统添加了基于 JWT (JSON Web Token) 的登录验证功能。以下操作需要登录后才能执行：

- ✅ 创建文章
- ✅ 更新文章（只能更新自己的文章）
- ✅ 删除文章（只能删除自己的文章）
- ✅ 创建评论
- ✅ 更新评论（只能更新自己的评论）
- ✅ 删除评论（只能删除自己的评论）

## 安装依赖

首先需要安装 PyJWT 库：

```bash
pip install PyJWT==2.8.0
```

或者安装所有依赖：

```bash
pip install -r requirements.txt
```

## API 使用说明

### 1. 用户登录

**接口**: `POST /api/users/login`

**请求体**:
```json
{
  "email": "user@example.com",
  "password": "your_password"
}
```

或者使用用户名登录：
```json
{
  "username": "username",
  "password": "your_password"
}
```

**响应示例**:
```json
{
  "message": "登录成功",
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "user": {
    "id": 1,
    "username": "testuser",
    "email": "user@example.com"
  }
}
```

**重要**: 保存返回的 `token`，后续请求需要携带此 token。

### 2. 使用 Token 访问受保护接口

在请求头中添加 `Authorization` 字段：

```
Authorization: Bearer <your_token>
```

或者简化为：

```
Authorization: <your_token>
```

### 3. 创建文章（需要登录）

**接口**: `POST /api/posts`

**请求头**:
```
Authorization: Bearer <your_token>
Content-Type: application/json
```

**请求体**:
```json
{
  "title": "文章标题",
  "content": "文章内容"
}
```

**注意**: 不再需要传递 `author_id`，系统会自动使用当前登录用户作为作者。

### 4. 更新文章（需要登录，只能更新自己的文章）

**接口**: `PUT /api/posts/<post_id>`

**请求头**:
```
Authorization: Bearer <your_token>
Content-Type: application/json
```

**请求体**:
```json
{
  "title": "新标题",
  "content": "新内容"
}
```

### 5. 删除文章（需要登录，只能删除自己的文章）

**接口**: `DELETE /api/posts/<post_id>`

**请求头**:
```
Authorization: Bearer <your_token>
```

### 6. 创建评论（需要登录）

**接口**: `POST /api/posts/<post_id>/comments`

**请求头**:
```
Authorization: Bearer <your_token>
Content-Type: application/json
```

**请求体**:
```json
{
  "content": "评论内容"
}
```

**注意**: 不再需要传递 `author_id`，系统会自动使用当前登录用户作为评论作者。

### 7. 更新评论（需要登录，只能更新自己的评论）

**接口**: `PUT /api/posts/comments/<comment_id>`

**请求头**:
```
Authorization: Bearer <your_token>
Content-Type: application/json
```

**请求体**:
```json
{
  "content": "更新后的评论内容"
}
```

### 8. 删除评论（需要登录，只能删除自己的评论）

**接口**: `DELETE /api/posts/comments/<comment_id>`

**请求头**:
```
Authorization: Bearer <your_token>
```

## 错误响应

### 未登录（401）
```json
{
  "error": "需要登录",
  "message": "请先登录后再进行操作"
}
```

### 无权限（403）
```json
{
  "error": "无权修改此文章"
}
```

或

```json
{
  "error": "无权删除此评论"
}
```

## 使用示例（使用 curl）

### 1. 登录获取 Token
```bash
curl -X POST http://127.0.0.1:5000/api/users/login \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "password123"}'
```

### 2. 创建文章
```bash
curl -X POST http://127.0.0.1:5000/api/posts \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{"title": "我的第一篇文章", "content": "这是文章内容"}'
```

### 3. 更新文章
```bash
curl -X PUT http://127.0.0.1:5000/api/posts/1 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{"title": "更新后的标题", "content": "更新后的内容"}'
```

## Token 有效期

- Token 有效期为 **7天**
- Token 过期后需要重新登录获取新 Token

## 安全说明

1. **密码加密**: 所有密码都使用 PBKDF2 算法进行哈希加密存储
2. **Token 安全**: Token 使用 HS256 算法签名，基于 `SECRET_KEY` 生成
3. **权限控制**: 用户只能修改和删除自己创建的文章和评论
4. **生产环境**: 请确保在生产环境中修改 `SECRET_KEY` 为强随机字符串
